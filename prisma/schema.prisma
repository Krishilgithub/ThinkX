// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Teacher Model - Only teachers can create courses
model Teacher {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String
  password String // Hashed password
  avatar   String?
  bio      String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courses Course[]
}

// Course Model - Contains all video generation parameters
model Course {
  id String @id @default(uuid())

  // Basic Info
  title       String
  subject     String // e.g., "Mathematics", "Science", "History"
  topic       String // Specific topic within the subject
  description String? @db.Text

  // Video Generation Parameters
  duration Int // Duration in seconds
  avatarId String // HeyGen avatar ID
  voiceId  String // HeyGen voice ID

  // Target Audience
  targetAudience String // e.g., "Students", "Professionals", "Beginners"
  ageGroup       String // e.g., "10-15", "16-20", "Adult"

  // Style & Tone
  style    String // e.g., "Professional", "Casual", "Educational"
  tone     String // e.g., "Formal", "Friendly", "Motivational"
  keywords String[] // Array of keywords for content generation

  // Metadata
  thumbnail String?
  status    String  @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED

  // Teacher Relation
  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Course Content
  chapters Chapter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([status])
}

// Chapter Model - Individual lessons/modules within a course
model Chapter {
  id          String  @id @default(uuid())
  title       String
  description String? @db.Text
  orderIndex  Int     @default(0)

  // Video Information
  videoUrl  String? // Generated video URL from HeyGen
  thumbnail String?
  duration  Int? // Actual duration in seconds
  script    String? @db.Text // Generated script for the video

  // Video Generation Status
  status      String  @default("DRAFT") // DRAFT, GENERATING, COMPLETED, FAILED
  heygenJobId String? // HeyGen video generation job ID

  // Course Relation
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Video Generation Jobs
  jobs VideoJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([status])
}

// VideoJob Model - Track video generation progress (Production-Ready)
model VideoJob {
  id String @id @default(uuid())

  // Relations
  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  // HeyGen Integration
  heygenJobId String? @unique // HeyGen API job ID
  
  // Status Tracking
  status      String  @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED | CANCELLED
  progress    Int     @default(0) // 0-100
  error       String? @db.Text
  errorCode   String? // Structured error codes (e.g., API_ERROR, TIMEOUT, INVALID_PARAMS)
  
  // Retry Logic
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  nextRetryAt DateTime?
  
  // Video Output
  videoUrl      String? // Final CDN URL (Cloudinary)
  thumbnailUrl  String?
  duration      Int? // Duration in seconds
  fileSize      Int? // File size in bytes
  
  // Generation Parameters (snapshot for this job)
  avatarId   String?
  voiceId    String?
  script     String? @db.Text
  background String? // HEX color
  language   String? // e.g., "en", "es"
  
  // Webhook Tracking
  webhookReceivedAt DateTime?
  webhookPayload    Json? // Store full webhook data for debugging
  
  // Timestamps
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  events JobEvent[]

  @@index([chapterId])
  @@index([status])
  @@index([heygenJobId])
  @@index([nextRetryAt])
  @@index([createdAt])
}

// JobEvent Model - Audit trail for video generation jobs
model JobEvent {
  id String @id @default(uuid())
  
  jobId     String
  job       VideoJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  eventType String // CREATED | QUEUED | PROCESSING | RETRY | COMPLETED | FAILED | WEBHOOK_RECEIVED | POLLING
  message   String? @db.Text
  metadata  Json? // Additional context (user_id, worker_id, etc.)
  
  createdAt DateTime @default(now())
  
  @@index([jobId])
  @@index([eventType])
  @@index([createdAt])
}


// HeyGen Avatar Model - Cache available avatars from HeyGen API
model HeyGenAvatar {
  id              String  @id @default(uuid())
  avatarId        String  @unique // HeyGen's avatar_id
  avatarName      String // Display name
  gender          String? // "male", "female", etc.
  previewImageUrl String? // Preview image URL
  previewVideoUrl String? // Preview video URL
  avatarStyle     String  @default("normal") // "normal", "circle"
  isPublic        Boolean @default(true)
  isAvailable     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isAvailable])
  @@index([isPublic])
  @@index([gender])
}
